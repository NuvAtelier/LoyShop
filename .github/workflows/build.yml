name: Build and Package

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for all branches and tags
      
    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven repository (~/.m2/repository)
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-jdk21-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-jdk21-
        
    - name: Cache SpigotBuildTools
      uses: actions/cache@v3
      with:
        path: |
          ./SpigotBuildTools
        key: ${{ runner.os }}-spigot-${{ hashFiles('buildMavenRepo.sh', 'buildMavenRepo.Dockerfile') }}
        restore-keys: |
          ${{ runner.os }}-spigot-
        
    - name: Compute version with commit hash
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          COMMIT_HASH=${{ github.event.pull_request.head.sha }}
        else
          COMMIT_HASH=${{ github.sha }}
        fi
        COMMIT_HASH=${COMMIT_HASH:0:7}

        CURRENT_VERSION=$(grep -m 1 "<revision>" pom.xml | sed 's/.*<revision>\(.*\)<\/revision>.*/\1/')
        NEW_VERSION="${CURRENT_VERSION}-${COMMIT_HASH}"

        echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
        echo "JAR_FILENAME=shop-${NEW_VERSION}.jar" >> $GITHUB_ENV
        
    - name: Generate Maven toolchains.xml (JDK 21)
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/toolchains.xml <<'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <toolchains>
          <toolchain>
            <type>jdk</type>
            <provides>
              <version>21</version>
              <vendor>any</vendor>
            </provides>
            <configuration>
              <jdkHome>${JAVA_HOME}</jdkHome>
            </configuration>
          </toolchain>
        </toolchains>
        EOF

    - name: Build Maven Repository
      run: |
        chmod +x ./buildMavenRepo.sh
        ./buildMavenRepo.sh
    
    - name: Pre-fetch Maven dependencies (go-offline)
      run: |
        mvn -B -nsu -Drevision=${{ env.VERSION }} -DskipTests dependency:go-offline
      
    - name: Build
      run: mvn -B -nsu -T 1C -Drevision=${{ env.VERSION }} clean package

    - name: Publish Test Results
      if: always() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
      uses: dorny/test-reporter@v1
      continue-on-error: true
      with:
        name: JUnit Tests
        path: '**/target/surefire-reports/*.xml'
        reporter: java-junit
        fail-on-error: false
        fail-on-empty: false

    # - name: Upload coverage to Codecov
    #   uses: codecov/codecov-action@v4
    #   continue-on-error: true
    #   with:
    #     files: '**/target/site/jacoco/jacoco.xml'
    #     flags: java
    #     fail_ci_if_error: false
    #     verbose: true
    #     # no need for token, it's not required for our use case
      
    - name: Generate diff-cover report
      if: always() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
      run: |
        chmod +x ./scripts/run-diff-cover.sh
        ./scripts/run-diff-cover.sh "origin/${{ github.base_ref }}" ./scripts/diff-cover.md ./scripts/diff-cover.html
      continue-on-error: true

    - name: Upload Artifact
      id: upload-shop-jar
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.JAR_FILENAME }}
        path: target/Shop-*.jar
        
    - name: Upload diff-cover HTML artifact
      if: always() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
      id: upload-diff-cover-report
      uses: actions/upload-artifact@v4
      with:
        name: diff-cover-report.html
        path: scripts/diff-cover.html

    - name: Create workflow summary
      if: always()
      run: |
        STATUS="${{ job.status }}"
        JAR_URL="${{ steps.upload-shop-jar.outputs.artifact-url }}"
        DIFF_URL="${{ steps.upload-diff-cover-report.outputs.artifact-url }}"
        {
          if [ "$STATUS" = "success" ]; then
            echo "# Build Completed Successfully! ðŸŽ‰"
          else
            echo "# Build Failed âŒ"
          fi
          echo ""
          echo "**Version:** $VERSION"
          if [ -n "$DIFF_URL" ]; then
            echo "**Diff Cover:** [View report]($DIFF_URL)"
          fi
          echo ""
          if [ -n "$JAR_URL" ]; then
            echo "### Download Build"
            echo "â¬‡ï¸ [$JAR_FILENAME]($JAR_URL)"
            echo ""
          fi
        } > build-summary.md
        cat build-summary.md >> "$GITHUB_STEP_SUMMARY"

    - name: Build Summary
      if: always() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        path: build-summary.md

    - name: Comment PR with JaCoCo Coverage Report
      if: always() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
      uses: madrapps/jacoco-report@v1.6.1
      continue-on-error: true
      with:
        paths: |
          **/target/site/jacoco/jacoco.xml
        token: ${{ secrets.GITHUB_TOKEN }}
        min-coverage-overall: 0
        min-coverage-changed-files: 30
        title: Coverage Report
        update-comment: true
        pass-emoji: ':green_circle:'
        fail-emoji: ':small_orange_diamond:'
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: target/Shop-*.jar 