name: Build and Package

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for all branches and tags
      
    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven repository (~/.m2/repository)
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-jdk21-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-jdk21-
        
    - name: Cache SpigotBuildTools
      uses: actions/cache@v3
      with:
        path: |
          ./SpigotBuildTools
        key: ${{ runner.os }}-spigot-${{ hashFiles('buildMavenRepo.sh', 'buildMavenRepo.Dockerfile') }}
        restore-keys: |
          ${{ runner.os }}-spigot-
        
    - name: Compute version with commit hash
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          COMMIT_HASH=${{ github.event.pull_request.head.sha }}
        else
          COMMIT_HASH=${{ github.sha }}
        fi
        COMMIT_HASH=${COMMIT_HASH:0:7}

        CURRENT_VERSION=$(grep -m 1 "<revision>" pom.xml | sed 's/.*<revision>\(.*\)<\/revision>.*/\1/')
        NEW_VERSION="${CURRENT_VERSION}-${COMMIT_HASH}"

        echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
        echo "JAR_FILENAME=shop-${NEW_VERSION}.jar" >> $GITHUB_ENV
        
    - name: Generate Maven toolchains.xml (JDK 21)
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/toolchains.xml <<'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <toolchains>
          <toolchain>
            <type>jdk</type>
            <provides>
              <version>21</version>
              <vendor>any</vendor>
            </provides>
            <configuration>
              <jdkHome>${JAVA_HOME}</jdkHome>
            </configuration>
          </toolchain>
        </toolchains>
        EOF

    - name: Build Maven Repository
      run: |
        chmod +x ./buildMavenRepo.sh
        ./buildMavenRepo.sh
    
    - name: Pre-fetch Maven dependencies (go-offline)
      run: |
        mvn -B -Pcoverage -nsu -Drevision=${{ env.VERSION }} -DskipTests dependency:go-offline
      
    - name: Build with Maven
      run: mvn -B -Pcoverage -nsu -T 1C -Drevision=${{ env.VERSION }} clean verify

    - name: Publish Test Results
      if: always() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
      uses: dorny/test-reporter@v1
      continue-on-error: true
      with:
        name: JUnit Tests
        path: '**/target/surefire-reports/*.xml'
        reporter: java-junit
        fail-on-error: false
        fail-on-empty: false

    - name: Comment PR with JaCoCo Coverage Report
      if: always() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
      uses: madrapps/jacoco-report@v1.6.1
      continue-on-error: true
      with:
        paths: |
          **/target/site/jacoco/jacoco.xml
        token: ${{ secrets.GITHUB_TOKEN }}
        min-coverage-overall: 0
        min-coverage-changed-files: 0
        title: Coverage Report
        update-comment: true

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      continue-on-error: true
      with:
        files: '**/target/site/jacoco/jacoco.xml'
        flags: java
        fail_ci_if_error: false
        verbose: true
        # no need for token, it's not required for our use case
      
    - name: Upload Artifact
      id: upload-shop-jar
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.JAR_FILENAME }}
        path: target/Shop-*.jar
        
    - name: Create workflow summary
      run: |
        echo "# Build Completed Successfully! 🎉" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Download Build" >> $GITHUB_STEP_SUMMARY
        echo "⬇️ [${{ env.JAR_FILENAME }}](${{ steps.upload-shop-jar.outputs.artifact-url }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: target/Shop-*.jar 